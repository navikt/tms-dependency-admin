name: Publiser jar-bundling plugin

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to update'
        required: false
        type: string
      commit_message:
        description: 'Commit message override'
        required: false
        type: string

jobs:
  setup-for-update-distribution:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate token
        run: |
          ./script/validate_token.sh
        env:
          API_ACCESS_TOKEN: ${{ secrets.API_ACCESS_TOKEN }}

  update-jar-plugin-for-managed-repositories:
    if: github.event.inputs.repository == ''
    name: ${{ matrix.managed-app }}
    runs-on: ubuntu-20.04
    needs:
      - setup-for-update-distribution
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        managed-app: ${{ fromJson(needs.setup-for-update-distribution.outputs.managed-apps) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate remote dependency and setup env
        run: |
          ./script/setup_repository.sh
        env:
          MANAGED_APP: ${{ matrix.managed-app }}
          API_ACCESS_TOKEN: ${{ secrets.API_ACCESS_TOKEN }}

      - name: Update jar bundling plugin and gradle build file in buildSrc
        run: |
          ./script/update_jar_plugin.sh
        env:
          REPOSITORY: ${{ env.repository }}
          API_ACCESS_TOKEN: ${{ secrets.API_ACCESS_TOKEN }}
          COMMIT_MESSAGE_OVERRIDE: ${{ inputs.commit_message }}
          MAIN_BRANCH: ${{ env.MAIN_BRANCH }}
          LATEST_COMMIT_SHA: ${{ env.LATEST_COMMIT_SHA }}

  update-jar-plugin-for-specified-repository:
    if: github.event.inputs.repository != ''
    name: ${{ inputs.repository }}
    runs-on: ubuntu-20.04
    needs:
      - setup-for-update-distribution
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate remote dependency and setup env
        run: |
          ./script/setup_repository.sh
        env:
          MANAGED_APP: ${{ inputs.REPOSITORY }}
          API_ACCESS_TOKEN: ${{ secrets.API_ACCESS_TOKEN }}

      - name: Update jar bundling plugin and gradle build file in buildSrc
        run: |
          ./script/update_jar_plugin.sh
        env:
          REPOSITORY: ${{ env.REPOSITORY }}
          API_ACCESS_TOKEN: ${{ secrets.API_ACCESS_TOKEN }}
          COMMIT_MESSAGE_OVERRIDE: ${{ inputs.commit_message }}
          MAIN_BRANCH: ${{ env.MAIN_BRANCH }}
          LATEST_COMMIT_SHA: ${{ env.LATEST_COMMIT_SHA }}
